<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fee Management Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{font-family:Arial;background:#f4f6f9;padding:15px}
h2{text-align:center}

.top-cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:10px;margin-bottom:15px
}
.card{
  background:#fff;padding:12px;border-radius:6px;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
  text-align:center;font-weight:bold
}

.filters{
  display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px
}
select,input,button{
  padding:7px;font-size:14px
}
button{cursor:pointer;background:#2563eb;color:#fff;border:none}

table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:7px;text-align:center}
th{background:#333;color:#fff}

.pending{color:red;font-weight:bold}
.paid{color:green;font-weight:bold}
.highlight{background:#fff1f1}

@media print{
  .filters,button{display:none}
}
</style>
</head>

<body>

<h2>Student Fee Dashboard</h2>

<div class="top-cards">
  <div class="card" id="totalStudents">Students: 0</div>
  <div class="card" id="totalFee">Total Fee: â‚¹0</div>
  <div class="card" id="totalPaid">Paid: â‚¹0</div>
  <div class="card" id="totalPending">Pending: â‚¹0</div>
</div>

<div class="filters">
  <select id="sessionFilter">
    <option value="">All Sessions</option>
  </select>

  <select id="classFilter">
    <option value="">All Classes</option>
  </select>

  <select id="statusFilter">
    <option value="">All Status</option>
    <option value="paid">Fully Paid</option>
    <option value="pending">Pending</option>
  </select>

  <input type="text" id="searchBox" placeholder="Search Scholar / Name / Phone">
  <button onclick="window.print()">Print</button>
</div>

<table>
<thead>
<tr>
<th>Scholar</th>
<th>Name</th>
<th>Father</th>
<th>Class</th>
<th>Total Fee</th>
<th>Paid</th>
<th>Pending</th>
<th>Phone</th>
<th>Status</th>
</tr>
</thead>
<tbody id="feeTable"></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx8CkpcdqwzLBV3KJ0-fJpZN1tqUcPwmQUlkIf10lPDXNNPQLRKdHtYjmfesbFwGQGw5A/exec";
let allData = [];

// ================= LOAD DATA =================
// ðŸ”„ Loading Spinner
Swal.fire({
  title: "Loading Data",
  text: "Please wait...",
  allowOutsideClick: false,
  didOpen: () => {
    Swal.showLoading();
  }
});

fetch(API_URL)
.then(r => r.json())
.then(data => {
  Swal.close(); // âœ… Spinner band
  allData = data;
  populateFilters(data);
  renderTable(data);
})
.catch(() => {
  Swal.close();
  Swal.fire("Error", "Data not loaded", "error");
});
// ================= FILTER DROPDOWNS =================
function populateFilters(data){
  [...new Set(data.map(d=>d.session))].forEach(s=>{
    sessionFilter.innerHTML += `<option>${s}</option>`;
  });
  [...new Set(data.map(d=>d.class))].forEach(c=>{
    classFilter.innerHTML += `<option>${c}</option>`;
  });
}

// ================= RENDER TABLE =================
function renderTable(data){
  let html="",total=0,paid=0,pending=0;
  data.forEach(d=>{
    const p = d.total - d.paid;
    total+=d.total; paid+=d.paid; pending+=p;
    html+=`
    <tr class="${p>0?'highlight':''}">
      <td>${d.scholar}</td>
      <td>${d.name}</td>
      <td>${d.father}</td>
      <td>${d.class}</td>
      <td>â‚¹${d.total}</td>
      <td class="paid">â‚¹${d.paid}</td>
      <td class="pending">â‚¹${p}</td>
      <td>${d.phone}</td>
      <td>${p>0?'Pending':'Paid'}</td>
    </tr>`;
  });
  feeTable.innerHTML=html;
  totalStudents.innerText="Students: "+data.length;
  totalFee.innerText="Total Fee: â‚¹"+total;
  totalPaid.innerText="Paid: â‚¹"+paid;
  totalPending.innerText="Pending: â‚¹"+pending;
}

// ================= APPLY FILTERS =================
document.querySelectorAll("select,input").forEach(el=>{
  el.addEventListener("input",()=>{
    let f = allData.filter(d=>{
      const p = d.total-d.paid;
      return (!sessionFilter.value||d.session==sessionFilter.value)
      &&(!classFilter.value||d.class==classFilter.value)
      &&(!statusFilter.value||(statusFilter.value=="pending"?p>0:p==0))
      &&(d.name+d.scholar+d.phone)
        .toLowerCase().includes(searchBox.value.toLowerCase());
    });
    renderTable(f);
  });
});
</script>

</body>
</html>


<!-----
function doGet() {

  const ss = SpreadsheetApp.getActive();
  const students = ss.getSheetByName("Students").getDataRange().getValues();
  const fees = ss.getSheetByName("StudentSessions").getDataRange().getValues();
  const txns = ss.getSheetByName("FeeTransactions").getDataRange().getValues();

  // ---------- Students Map ----------
  let studentMap = {};
  for(let i = 1; i < students.length; i++){
    let [scholar, name, father, , phone] = students[i]; // ðŸ‘ˆ Mother skipped
    studentMap[scholar] = {
      name: name || "",
      father: father || "",
      phone: phone || ""
    };
  }

  // ---------- Paid Amount Map ----------
  let paidMap = {};
  for(let i = 1; i < txns.length; i++){
    let [date, scholar, session, cls, amount] = txns[i];
    let key = scholar + "_" + session + "_" + cls;
    paidMap[key] = (paidMap[key] || 0) + Number(amount);
  }

  // ---------- Final Result ----------
  let result = [];

  for(let i = 1; i < fees.length; i++){
    let [scholar, session, cls, total] = fees[i];
    let paid = paidMap[scholar + "_" + session + "_" + cls] || 0;
    let s = studentMap[scholar] || {};

    result.push({
      scholar: scholar,
      name: s.name,
      father: s.father,
      phone: s.phone,
      session: session,
      class: cls,
      total: Number(total),
      paid: Number(paid),
      pending: Number(total) - Number(paid)
    });
  }

  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}
