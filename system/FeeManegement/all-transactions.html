<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>All Fee Transactions</title>
<link rel="icon" href="../../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css">

  <!-- Bootstrap Core Css -->
  <link href="https://trollifyindustry.github.io/premjanghela/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">

  <!-- Waves Effect Css -->
  <link href="https://trollifyindustry.github.io/premjanghela/plugins/node-waves/waves.css" rel="stylesheet" />

  <!-- Animation Css -->
  <link href="https://trollifyindustry.github.io/premjanghela/plugins/animate-css/animate.css" rel="stylesheet" />

  <!-- Custom Css -->
  <link href="https://trollifyindustry.github.io/premjanghela/css/style.css" rel="stylesheet">

  <!-- AdminBSB Themes. You can choose a theme from css/themes instead of get all themes -->
  <link href="https://trollifyindustry.github.io/premjanghela/css/themes/all-themes.css" rel="stylesheet" />

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.pending{color:red;font-weight:bold}
.paid{color:green;font-weight:bold}

@media print{
  .top-bar{display:none}
}
</style>
</head>

<body>



<section class="content">
    <div class="container-fluid">
     
        <!-- Basic Table -->
        <div class="row clearfix">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card">
                    <div class="header">
                        <h2>
                           All Fee Transactions
                            <small>  <input type="text" id="searchBox" placeholder="Search Name / Scholar / Father / Amount / Mode / Receiver"></small>
                        </h2>
                        <ul class="header-dropdown m-r--5">
                            <li class="dropdown">
                                <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                    <i class="material-icons">more_vert</i>
                                </a>
                                <ul class="dropdown-menu pull-right">
                                    <li><a onclick="window.print()">Print</a></li>
                                    <li><a href="javascript:void(0);">Another action</a></li>
                                    <li><a href="javascript:void(0);">Something else here</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div class="body table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Scholar</th>
                                    <th>Name</th>
                                    <th>Father</th>
                                    <th>Date</th>
                                    <th>Session</th>
                                    <th>Class</th>
                                    <th>Total Fee</th>
                                    <th>Paid</th>
                                    <th>Pending</th>
                                    <th>Mode</th>
                                    <th>Received By</th>
                                    <th>Remark</th>
                                </tr>
                            </thead>
                            <tbody id="txnTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- #END# Basic Table -->
    </div>
</section>



<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwmdgUFKSJ5WhwVLsEcYq2rp2vUwOKd0YTHA2KqrFVvp_y37bm4f_ObafohxNECsyi2lQ/exec";

let allData=[];

// ðŸ”„ LOADING
Swal.fire({
  title:"Loading Transactions...",
  allowOutsideClick:false,
  didOpen:()=>Swal.showLoading()
});

fetch(API_URL)
.then(r=>r.json())
.then(data=>{
  allData=data;
  render(data);
  Swal.close();
})
.catch(()=>{
  Swal.fire("Error","Data load failed","error");
});

function render(data){
  let html="";
  data.forEach(d=>{
    html+=`
    <tr>
      <td>${d.scholar}</td>
      <td>${d.name}</td>
      <td>${d.father}</td>
      <td>${formatDate(d.date)}</td>
      <td>${d.session}</td>
      <td>${d.class}</td>
      <td>â‚¹${d.total}</td>
      <td class="paid">â‚¹${d.paid}</td>
      <td class="pending">â‚¹${d.pending}</td>
      <td>${d.mode}</td>
      <td>${d.receiver}</td>
      <td>${d.remark||""}</td>
    </tr>`;
  });
  txnTable.innerHTML=html;
}

// ðŸ” SEARCH
searchBox.addEventListener("input",()=>{
  const q = searchBox.value.toLowerCase();
  const f = allData.filter(d=>
    (d.scholar+d.name+d.father+d.paid+d.mode+d.receiver)
    .toLowerCase().includes(q)
  );
  render(f);
});

// ðŸ“… DATE FORMAT
function formatDate(d){
  const dt = new Date(d);
  return `${String(dt.getDate()).padStart(2,'0')}/
          ${String(dt.getMonth()+1).padStart(2,'0')}/
          ${dt.getFullYear()}`;
}
</script>
<!-- Jquery Core Js -->
   <script src="https://trollifyindustry.github.io/premjanghela/plugins/jquery/jquery.min.js"></script>

   <!-- Bootstrap Core Js -->
   <script src="https://trollifyindustry.github.io/premjanghela/plugins/bootstrap/js/bootstrap.js"></script>

   <!-- Select Plugin Js -->
   <script src="https://trollifyindustry.github.io/premjanghela/plugins/bootstrap-select/js/bootstrap-select.js"></script>

   <!-- Slimscroll Plugin Js -->
   <script src="https://trollifyindustry.github.io/premjanghela/plugins/jquery-slimscroll/jquery.slimscroll.js"></script>

   <!-- Waves Effect Plugin Js -->
   <script src="https://trollifyindustry.github.io/premjanghela/plugins/node-waves/waves.js"></script>

   <!-- Custom Js -->
   <script src="https://trollifyindustry.github.io/premjanghela/js/admin.js"></script>
   <script src="https://trollifyindustry.github.io/premjanghela/js/pages/examples/profile.js"></script>

   <!-- Demo Js -->
   <script src="https://trollifyindustry.github.io/premjanghela/js/demo.js"></script>

</body>
</html>


<!-------

function doGet() {

  const ss = SpreadsheetApp.getActive();

  const students = ss.getSheetByName("Students").getDataRange().getValues();
  const sessions = ss.getSheetByName("StudentSessions").getDataRange().getValues();
  const txns = ss.getSheetByName("FeeTransactions").getDataRange().getValues();

  // ================= MAP STUDENTS =================
  let studentMap = {};
  for(let i=1;i<students.length;i++){
    let [scholar,name,father,phone] = students[i];
    studentMap[scholar] = {name,father,phone};
  }

  // ================= MAP TOTAL FEE =================
  let totalFeeMap = {};
  for(let i=1;i<sessions.length;i++){
    let [scholar,session,cls,total] = sessions[i];
    totalFeeMap[`${scholar}_${session}_${cls}`] = Number(total);
  }

  // ================= PROCESS TRANSACTIONS =================
  let paidTillNow = {};
  let result = [];

  for(let i=1;i<txns.length;i++){
    let [date,scholar,session,cls,amount,mode,payer,receiver,remark] = txns[i];

    let key = `${scholar}_${session}_${cls}`;
    paidTillNow[key] = (paidTillNow[key] || 0) + Number(amount);

    let totalFee = totalFeeMap[key] || 0;
    let pending = totalFee - paidTillNow[key];

    let s = studentMap[scholar] || {};

    result.push({
      scholar,
      name: s.name || "",
      father: s.father || "",
      date,
      session,
      class: cls,
      total: totalFee,
      paid: Number(amount),
      pending,
      mode,
      receiver,
      remark
    });
  }

  // ðŸ”¥ NEWEST FIRST
  result.reverse();

  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

----->
