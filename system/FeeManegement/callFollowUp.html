<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fee Follow Up</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#111;
  color:#fff;
  margin:0;
  padding:15px;
}
input,select,button{
  padding:8px;
  border-radius:5px;
  border:none;
  margin:3px;
}
button{
  background:#00c853;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #333;
  padding:6px;
  text-align:center;
}
th{background:#222}
tr:hover{background:#1f1f1f}
.phone{
  color:#00e5ff;
  cursor:pointer;
}
.paid{color:#00e676;font-weight:bold}
.unpaid{color:#ff5252;font-weight:bold}
</style>
</head>

<body>

<h2>ðŸ“ž Fee Follow-Up Dashboard</h2>

<input id="search" placeholder="Search Name / Scholar / Phone">
<input type="date" id="dateFilter">

<select id="payAfterFilter">
  <option value="">All Pay After</option>
  <option>1 Day</option>
  <option>7 Days</option>
  <option>15 Days</option>
  <option>1 Month</option>
</select>

<table>
<thead>
<tr>
<th>Scholar</th>
<th>Name</th>
<th>Class</th>
<th>Phone</th>
<th>Status</th>
<th>Last Call</th>
<th>Pay After</th>
<th>Reason</th>
<th>Remark</th>
<th>Save</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwYx_C7o9u0LHoAZCRCoc3JnJSwT3Nuy_GAPTWn2D84D7xfJNmnJcBHWqmN_SVvaQZMLQ/exec";

let allData = [];

Swal.fire({
  title: "Loading...",
  allowOutsideClick: false,
  didOpen: () => Swal.showLoading()
});

fetch(API_URL)
.then(r=>r.json())
.then(d=>{
  allData = d;
  render(d);
  Swal.close();
});

function render(data){
  tbody.innerHTML="";
  data.forEach(s=>{
    let tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${s.scholar}</td>
      <td>${s.name}</td>
      <td>${s.class}</td>
      <td class="phone" onclick="call('${s.phone}')">${s.phone}</td>
      <td class="${s.pending=='Paid'?'paid':'unpaid'}">${s.pending}</td>
      <td><input type="date" value="${s.callDate||''}" id="d${s.scholar}"></td>
      <td>
        <select id="p${s.scholar}">
          <option>${s.payAfter||''}</option>
          <option>1 Day</option>
          <option>7 Days</option>
          <option>15 Days</option>
          <option>1 Month</option>
        </select>
      </td>
      <td><input id="r${s.scholar}" value="${s.reason||''}"></td>
      <td><input id="m${s.scholar}" value="${s.remark||''}"></td>
      <td><button onclick="save('${s.scholar}')">Save</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function call(num){
  location.href = "tel:"+num;
}

function save(sch){
  Swal.fire({
    title:"Are you sure?",
    icon:"question",
    showCancelButton:true
  }).then(res=>{
    if(!res.isConfirmed) return;

    Swal.fire({
      title:"Saving...",
      allowOutsideClick:false,
      didOpen:()=>Swal.showLoading()
    });

    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        scholar:sch,
        callDate:document.getElementById("d"+sch).value,
        callBy:"Admin",
        payAfter:document.getElementById("p"+sch).value,
        reason:document.getElementById("r"+sch).value,
        remark:document.getElementById("m"+sch).value
      })
    }).then(r=>r.json())
     .then(()=>{
       Swal.fire("Saved","Follow-up updated","success");
     });
  });
}

document.querySelectorAll("#search,#dateFilter,#payAfterFilter")
.forEach(el=>{
  el.addEventListener("input",()=>{
    let q=search.value.toLowerCase();
    let d=dateFilter.value;
    let p=payAfterFilter.value;

    render(allData.filter(s=>
      (!q||(s.name+s.scholar+s.phone).toLowerCase().includes(q)) &&
      (!d||s.callDate===d) &&
      (!p||s.payAfter===p)
    ));
  });
});
</script>

</body>
</html>


<!---

function doGet() {
  const ss = SpreadsheetApp.getActive();

  const students = ss.getSheetByName("Students").getDataRange().getValues();
  const sessions = ss.getSheetByName("StudentSessions").getDataRange().getValues();
  const txns = ss.getSheetByName("FeeTransactions").getDataRange().getValues();
  const follow = ss.getSheetByName("FeeFollowUp").getDataRange().getValues();

  // ========= STUDENT MAP =========
  let studentMap = {};
  for (let i = 1; i < students.length; i++) {
    let [sch, name, father, mother, phone] = students[i];
    studentMap[sch] = { name, father, mother, phone };
  }

  // ========= PAID MAP =========
  let paidMap = {};
  for (let i = 1; i < txns.length; i++) {
    let [, sch, session, , amt] = txns[i];
    let key = sch + "_" + session;
    paidMap[key] = (paidMap[key] || 0) + Number(amt);
  }

  // ========= FOLLOW UP MAP =========
  let followMap = {};
  for (let i = 1; i < follow.length; i++) {
    let [sch, callDate, callBy, payAfter, reason, remark] = follow[i];
    followMap[sch] = { callDate, callBy, payAfter, reason, remark };
  }

  // ========= FIND LATEST SESSION =========
  let latestSession = sessions
    .slice(1)
    .map(r => r[1])
    .sort()
    .pop(); // example 2025-26

  // ========= UNIQUE STUDENTS (LATEST ONLY) =========
  let resultMap = {};

  for (let i = 1; i < sessions.length; i++) {
    let [sch, session, cls, total] = sessions[i];

    if (session !== latestSession) continue; // â— ignore old session
    if (resultMap[sch]) continue; // â— avoid duplicate scholar

    let paid = paidMap[sch + "_" + session] || 0;
    let s = studentMap[sch] || {};
    let f = followMap[sch] || {};

    resultMap[sch] = {
      scholar: sch,
      class: cls,
      session,
      pending: paid > 0 ? "Paid" : "Unpaid",
      name: s.name || "",
      father: s.father || "",
      phone: s.phone || "",
      callDate: formatDate(f.callDate),
      callBy: f.callBy || "",
      payAfter: f.payAfter || "",
      reason: f.reason || "",
      remark: f.remark || ""
    };
  }

  return ContentService
    .createTextOutput(JSON.stringify(Object.values(resultMap)))
    .setMimeType(ContentService.MimeType.JSON);
}

// ========= SAVE =========
function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const sh = SpreadsheetApp.getActive().getSheetByName("FeeFollowUp");
  const rows = sh.getDataRange().getValues();

  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.scholar) {
      sh.getRange(i + 1, 2, 1, 6).setValues([[
        data.callDate,
        data.callBy,
        data.payAfter,
        data.reason,
        data.remark,
        new Date()
      ]]);
      return ok();
    }
  }

  sh.appendRow([
    data.scholar,
    data.callDate,
    data.callBy,
    data.payAfter,
    data.reason,
    data.remark,
    new Date()
  ]);

  return ok();
}

function formatDate(d) {
  if (!d) return "";
  if (Object.prototype.toString.call(d) === "[object Date]") {
    return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd");
  }
  return d;
}

function ok() {
  return ContentService.createTextOutput(JSON.stringify({ status: "success" }))
    .setMimeType(ContentService.MimeType.JSON);
}
--->
