<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fee Follow Up</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* ‚ùå CSS SAME ‚Äì NO CHANGE */
body{
  font-family: Arial, sans-serif;
  background:#111;
  color:#fff;
  margin:0;
  padding:15px;
}
input,select,button{
  padding:8px;
  border-radius:5px;
  border:none;
  margin:3px;
}
button{
  background:#00c853;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #333;
  padding:6px;
  text-align:center;
}
th{background:#222}
tr:hover{background:#1f1f1f}
.phone{color:#00e5ff;cursor:pointer}
.paid{color:#00e676;font-weight:bold}
.unpaid{color:#ff5252;font-weight:bold}
</style>
</head>

<body>

<h2>üìû Fee Follow-Up Dashboard</h2>

<!-- üîç FILTERS -->
<input id="search" placeholder="Search Name / Scholar / Phone">

<input type="date" id="lastCallFilter" title="Last Call Date">
<input type="date" id="nextCallFilter" title="Next Call Date">

<select id="statusFilter">
  <option value="">All Status</option>
  <option value="Paid">Paid</option>
  <option value="Unpaid">Unpaid</option>
</select>

<select id="classFilter">
  <option value="">All Classes</option>
</select>

<button onclick="todayTask()">üìû Today's Calling Task</button>

<table>
<thead>
<tr>
<th>Sr</th>
<th>Scholar</th>
<th>Name</th>
<th>Class</th>
<th>Phone</th>
<th>Status</th>
<th>Last Call</th>
<th>Next Call</th>
<th>Reason</th>
<th>Remark</th>
<th>Save</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzi5yml3XRtxFIjFVs7u81GA8pabnPrUmrODA30MyPwHj7keBgwhhb6eQ4JMFnkkD3KEQ/exec";

let allData=[];

Swal.fire({title:"Loading...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});

fetch(API_URL)
.then(r=>r.json())
.then(d=>{
  allData=d;
  fillClassFilter(d);
  render(d);
  Swal.close();
});

function render(data){
  tbody.innerHTML="";
  data.forEach((s,i)=>{
    tbody.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${s.scholar}</td>
<td>${s.name}</td>
<td>${s.class}</td>
<td class="phone" onclick="call('${s.phone}')">${s.phone}</td>
<td class="${s.pending=='Paid'?'paid':'unpaid'}">${s.pending}</td>
<td><input type="date" id="d${s.scholar}" value="${s.callDate||''}"></td>
<td><input type="date" id="n${s.scholar}" value="${s.nextCallDate||''}"></td>
<td><input id="r${s.scholar}" value="${s.reason||''}"></td>
<td><input id="m${s.scholar}" value="${s.remark||''}"></td>
<td><button onclick="save('${s.scholar}')">Save</button></td>
</tr>`;
  });
}

function call(n){ location.href="tel:"+n; }

/* üéØ TODAY TASK BUTTON */
function todayTask(){
  let today=new Date().toISOString().slice(0,10);
  nextCallFilter.value=today;
  applyFilters();
}

/* üîç FILTER LOGIC */
function applyFilters(){
  let q=search.value.toLowerCase();
  let lc=lastCallFilter.value;
  let nc=nextCallFilter.value;
  let st=statusFilter.value;
  let cl=classFilter.value;

  render(allData.filter(s=>
    (!q||(s.name+s.scholar+s.phone).toLowerCase().includes(q)) &&
    (!lc||s.callDate===lc) &&
    (!nc||s.nextCallDate===nc) &&
    (!st||s.pending===st) &&
    (!cl||s.class===cl)
  ));
}

document.querySelectorAll(
  "#search,#lastCallFilter,#nextCallFilter,#statusFilter,#classFilter"
).forEach(e=>e.addEventListener("input",applyFilters));

/* üè´ CLASS FILTER AUTO FILL */
function fillClassFilter(data){
  let cls=[...new Set(data.map(d=>d.class))];
  cls.forEach(c=>{
    classFilter.innerHTML+=`<option>${c}</option>`;
  });
}

/* üíæ SAVE */
function save(sch){
  Swal.fire({title:"Are you sure?",showCancelButton:true})
  .then(res=>{
    if(!res.isConfirmed) return;

    Swal.fire({title:"Saving...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});

    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        scholar:sch,
        callDate:document.getElementById("d"+sch).value,
        nextCallDate:document.getElementById("n"+sch).value,
        callBy:"Admin",
        reason:document.getElementById("r"+sch).value,
        remark:document.getElementById("m"+sch).value
      })
    }).then(()=>Swal.fire("Saved","Updated","success"));
  });
}
</script>

</body>
</html>
<!-----
function doGet() {
  const ss = SpreadsheetApp.getActive();

  const students = ss.getSheetByName("Students").getDataRange().getValues();
  const sessions = ss.getSheetByName("StudentSessions").getDataRange().getValues();
  const txns = ss.getSheetByName("FeeTransactions").getDataRange().getValues();
  const follow = ss.getSheetByName("FeeFollowUp").getDataRange().getValues();

  // ================= STUDENT MAP =================
  let studentMap = {};
  for (let i = 1; i < students.length; i++) {
    let [sch, name, father, mother, phone] = students[i];
    studentMap[sch] = { name, father, mother, phone };
  }

  // ================= PAID MAP (SESSION WISE) =================
  let paidMap = {};
  for (let i = 1; i < txns.length; i++) {
    let [, sch, session, , amt] = txns[i];
    let key = sch + "_" + session;
    paidMap[key] = (paidMap[key] || 0) + Number(amt);
  }

  // ================= FOLLOW UP MAP =================
  let followMap = {};
  for (let i = 1; i < follow.length; i++) {
    let [sch, callDate, callBy, nextCallDate, reason, remark] = follow[i];
    followMap[sch] = {
      callDate,
      callBy,
      nextCallDate,
      reason,
      remark
    };
  }

  // ================= FIND LATEST SESSION =================
  let latestSession = sessions
    .slice(1)
    .map(r => r[1])
    .sort()
    .pop(); // eg: 2025-26

  // ================= UNIQUE STUDENTS (LATEST ONLY) =================
  let resultMap = {};

  for (let i = 1; i < sessions.length; i++) {
    let [sch, session, cls, total] = sessions[i];

    if (session !== latestSession) continue;     // ‚ùå old session ignore
    if (resultMap[sch]) continue;                // ‚ùå duplicate scholar ignore

    let paid = paidMap[sch + "_" + session] || 0;
    let s = studentMap[sch] || {};
    let f = followMap[sch] || {};

    resultMap[sch] = {
      scholar: sch,
      class: cls,
      session: session,
      pending: paid > 0 ? "Paid" : "Unpaid",

      name: s.name || "",
      father: s.father || "",
      phone: s.phone || "",

      callDate: formatDate(f.callDate),
      nextCallDate: formatDate(f.nextCallDate), // ‚úÖ FIXED
      callBy: f.callBy || "",
      reason: f.reason || "",
      remark: f.remark || ""
    };
  }

  return ContentService
    .createTextOutput(JSON.stringify(Object.values(resultMap)))
    .setMimeType(ContentService.MimeType.JSON);
}

// ================= SAVE FOLLOW UP =================
function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const sh = SpreadsheetApp.getActive().getSheetByName("FeeFollowUp");
  const rows = sh.getDataRange().getValues();

  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.scholar) {
      sh.getRange(i + 1, 2, 1, 6).setValues([[
        data.callDate || "",
        data.callBy || "",
        data.nextCallDate || "",
        data.reason || "",
        data.remark || "",
        new Date()
      ]]);
      return ok();
    }
  }

  sh.appendRow([
    data.scholar,
    data.callDate || "",
    data.callBy || "",
    data.nextCallDate || "",
    data.reason || "",
    data.remark || "",
    new Date()
  ]);

  return ok();
}

// ================= DATE FORMAT =================
function formatDate(d) {
  if (!d) return "";
  if (Object.prototype.toString.call(d) === "[object Date]") {
    return Utilities.formatDate(
      d,
      Session.getScriptTimeZone(),
      "yyyy-MM-dd"
    );
  }
  return d;
}

// ================= RESPONSE =================
function ok() {
  return ContentService
    .createTextOutput(JSON.stringify({ status: "success" }))
    .setMimeType(ContentService.MimeType.JSON);
}
 ---->
