<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Fee Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body{font-family:Arial, sans-serif;background:#0f172a;color:#fff;margin:0;padding:20px}
    .container{max-width:700px;margin:auto}
    .card{background:#1e293b;padding:20px;border-radius:12px;margin-bottom:20px}
    .field{margin-bottom:12px}
    label{display:block;margin-bottom:4px;font-weight:bold}
    input,select{width:100%;padding:8px;border-radius:6px;border:none}
    .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
    .btn-primary{background:#3b82f6;color:white}
    .btn-secondary{background:#64748b;color:white}
    .spinner{border:6px solid #ddd;border-top:6px solid #3b82f6;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:auto}
    @keyframes spin{100%{transform:rotate(360deg)}}
    .overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:9999;flex-direction:column}
    .powered{margin-top:150px;font-weight:bold}
  </style>
</head>
<body>
<div class="container">
  <h2>Student Fee Entry</h2>

  <div class="card">
    <div class="field">
      <label>Scholar No.</label>
      <input type="text" id="scholarSearch" placeholder="Enter scholar no...">
    </div>
    <button class="btn btn-primary" onclick="searchStudent()">Search</button>
  </div>

  <div class="card">
    <div class="field"><label>Scholar No.</label><input id="scholar" readonly></div>
    <div class="field"><label>Name</label><input id="name" readonly></div>
    <div class="field"><label>Father</label><input id="father" readonly></div>
    <div class="field"><label>Class</label><input id="className" readonly></div>
    <div class="field"><label>Total Fee</label><input id="totalFee" type="number"></div>
    <div class="field"><label>Paid Amount</label><input id="paidAmount" type="number"></div>
    <div class="field"><label>Payment Mode</label>
      <select id="paymentMode">
        <option value="">--Select--</option>
        <option>Cash</option><option>Phone Pe</option><option>Google Pay</option><option>UPI</option><option>Bank</option><option>Card</option>
      </select>
    </div>
    <div class="field">
        <label>Receiver Name</label>
     <select id="receiverName" required>
       <option value="">-- Select Receiver --</option>
       <option value="Vandana Sulakhiya">Vandana Sulakhiya</option>
       <option value="Varsha Sulakhiya">Varsha Sulakhiya</option>
     </select>
    </div>
    <div class="field"><label>Remarks</label><input id="remarks"></div>
    <button class="btn btn-primary" onclick="submitData()">Submit</button>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <div class="powered">Powered By Prem Janghela</div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzSOowy2mQLOZr2ZBR-UIiyfAtjN1yB5AzftM9tWas3NGqovXCNn_xGjD7OQuo7Kfby/exec";

  function showSpinner(){document.getElementById("overlay").style.display="flex"}
  function hideSpinner(){document.getElementById("overlay").style.display="none"}

  async function searchStudent(){
    const scholar = document.getElementById("scholarSearch").value.trim();
    if(!scholar){Swal.fire("Enter scholar no.");return}
    showSpinner();
    try{
      const res = await fetch(`${API_URL}?action=getStudent&scholar=${scholar}`);
      const data = await res.json();
      hideSpinner();
      if(data.ok){
        document.getElementById("scholar").value = data.data.scholar;
        document.getElementById("name").value = data.data.name;
        document.getElementById("father").value = data.data.father;
        document.getElementById("className").value = data.data.className;
        Swal.fire("Student found!");
      } else {
        Swal.fire("Not found", data.msg, "error");
      }
    } catch(err){hideSpinner();Swal.fire("Error", err, "error")}
  }

  async function submitData(){
    const payload={
      scholar:scholar.value,name:name.value,father:father.value,className:className.value,
      totalFee:totalFee.value,paidAmount:paidAmount.value,paymentMode:paymentMode.value,
      receiverName:receiverName.value,remarks:remarks.value
    };
    if(!payload.scholar||!payload.totalFee||!payload.paidAmount||!payload.paymentMode||!payload.receiverName){
      Swal.fire("Fill all required fields");return;
    }
    Swal.fire({title:"Are you sure?",showCancelButton:true}).then(async(result)=>{
      if(result.isConfirmed){
        showSpinner();
        try{
          const res = await fetch(`${API_URL}?action=submit&payload=${encodeURIComponent(JSON.stringify(payload))}`);
          const data = await res.json();
          hideSpinner();
          if(data.ok){Swal.fire("Success",data.msg,"success")}
          else{Swal.fire("Failed",data.msg,"error")}
        }catch(err){hideSpinner();Swal.fire("Error",err,"error")}
      }
    })
  }
  
  
</script>
<script>
  // URL से scholar parameter लो
  const urlParams = new URLSearchParams(window.location.search);
  const scholarNo = urlParams.get("scholar");

  // अगर scholar number URL में मिला तो input में set कर दो
  if (scholarNo) {
    document.getElementById("scholarSearch").value = scholarNo;
  }
</script>
</body>
</html>


<!-----
const SHEET1 = "Sheet1"; // Scholar, Name, Father, Class
const SHEET2 = "Sheet2"; // Scholar, Name, Father, Class, Total Fee, Paid, Mode, Receiver, Remarks, DateTime

function doGet(e) {
  const action = e.parameter.action;

  if (action === "getStudent") {
    const scholar = e.parameter.scholar;
    return ContentService.createTextOutput(
      JSON.stringify(getStudent(scholar))
    ).setMimeType(ContentService.MimeType.JSON);
  }

  if (action === "submit") {
    const payload = JSON.parse(e.parameter.payload);
    return ContentService.createTextOutput(
      JSON.stringify(savePayment(payload))
    ).setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(JSON.stringify({ ok: false, msg: "Invalid request" }))
    .setMimeType(ContentService.MimeType.JSON);
}

function getStudent(scholarNo) {
  const sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET1);
  const data = sh.getRange(2, 1, sh.getLastRow() - 1, 4).getValues(); // A-D

  for (let row of data) {
    if (String(row[0]).trim() === String(scholarNo).trim()) {
      return { ok: true, data: { scholar: row[0], name: row[1], father: row[2], className: row[3] } };
    }
  }
  return { ok: false, msg: "Scholar not found in Sheet1" };
}

function savePayment(p) {
  try {
    const sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET2);
    const now = new Date();
    sh.appendRow([p.scholar, p.name, p.father, p.className, p.totalFee, p.paidAmount, p.paymentMode, p.receiverName, p.remarks, now]);
    sh.getRange(sh.getLastRow(), 10).setNumberFormat("yyyy-MM-dd HH:mm:ss");
    return { ok: true, msg: "Saved successfully" };
  } catch (err) {
    return { ok: false, msg: err.message };
  }
}
